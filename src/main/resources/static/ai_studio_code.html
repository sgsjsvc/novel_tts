<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è¯´è§’è‰²æ¨¡å‹é…ç½®</title>

    <!-- æ ·å¼åº“ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-5-theme/1.3.0/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        :root {
            /* ç»Ÿä¸€è‰²è°ƒ - æç®€è“ç´« */
            --color-primary: #5e6bff;   /* ä¸»è‰² */
            --color-primary-light: #e8ebff;
            --color-success: #10b981;
            --color-danger: #ef4444;
            --color-warning: #f59e0b;
            --color-gray: #6b7280;
            --color-bg: #f8fafc;
            --color-card: #ffffff;
            --color-border: #e2e8f0;
        }

        body {
            background: #f1f5f9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding: 20px 0;
            color: #1e293b;
        }

        .main-card {
            max-width: 1300px;
            margin: 30px auto;
            background: var(--color-card);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            overflow: hidden;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .card-header {
            background: var(--color-primary);
            color: white;
            padding: 28px 35px;
            border: none;
        }

        .card-header h4 {
            font-weight: 700;
            font-size: 1.8rem;
            margin: 0;
        }

        .novel-selector {
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 12px 18px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .novel-selector label {
            color: white;
            font-weight: 600;
            margin: 0;
            font-size: 1.1rem;
        }

        #novelSelect {
            min-width: 280px;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .custom-table thead th {
            background: var(--color-primary);
            color: white;
            font-weight: 600;
            padding: 16px 15px;
            border: none;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .custom-table tbody tr:hover {
            background: var(--color-primary-light);
            transform: translateX(3px);
        }

        /* å¾½ç«  */
        .gender-badge,
        .version-badge,
        .id-badge {
            padding: 6px 14px;
            border-radius: 25px;
            font-size: 0.88em;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: white;
        }

        .gender-male    { background: #3b82f6; }
        .gender-female  { background: #ec4899; }
        .gender-unknown { background: #94a3b8; }
        .version-badge  { background: #10b981; }
        .id-badge       { background: #8b5cf6; }

        .char-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #1e293b;
        }

        /* Select2 */
        .model-select,
        .select2-container--bootstrap-5 .select2-selection {
            border: 2px solid #cbd5e1 !important;
            border-radius: 10px !important;
        }

        .select2-container--bootstrap-5.select2-container--focus .select2-selection,
        .model-select:focus {
            border-color: var(--color-primary) !important;
            box-shadow: 0 0 0 0.2rem rgba(94, 107, 255, 0.2) !important;
        }

        .empty-state {
            padding: 60px 20px;
            text-align: center;
            color: var(--color-gray);
        }

        .empty-state i {
            font-size: 4rem;
            opacity: 0.5;
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            .card-header { flex-direction: column; gap: 16px; text-align: center; }
            .novel-selector { width: 100%; flex-direction: column; }
            #novelSelect { width: 100% !important; }
        }
    </style>
</head>
<body>

<div class="card main-card">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
        <h4><i class="bi bi-book-fill"></i> å°è¯´è§’è‰²æ¨¡å‹é…ç½®ç³»ç»Ÿ</h4>
        <div class="novel-selector">
            <label for="novelSelect"><i class="bi bi-journal-text"></i> é€‰æ‹©å°è¯´</label>
            <!-- æ ¸å¿ƒä¿®æ”¹ï¼šç§»é™¤ç¡¬ç¼–ç çš„ optionï¼Œåªä¿ç•™ placeholder -->
            <select id="novelSelect" class="form-select" style="width: 280px;">
                <option value="" disabled selected>â³ æ­£åœ¨åŠ è½½å°è¯´åˆ—è¡¨...</option>
            </select>
        </div>
    </div>

    <div class="card-body p-0">
        <table class="table custom-table table-hover mb-0">
            <thead>
            <tr>
                <th style="width: 80px;"><i class="bi bi-hash"></i> ID</th>
                <th style="width: 280px;"><i class="bi bi-person-fill"></i> è§’è‰²å</th>
                <th style="width: 180px;"><i class="bi bi-gender-ambiguous"></i> æ€§åˆ«</th>
                <th style="width: 180px;"><i class="bi bi-tag-fill"></i> ç‰ˆæœ¬</th>
                <th><i class="bi bi-cpu-fill"></i> æ¨¡å‹é€‰æ‹©</th>
            </tr>
            </thead>
            <tbody id="tableBody">
            <tr>
                <td colspan="5">
                    <div class="empty-state">
                        <i class="bi bi-book"></i>
                        <p>è¯·åœ¨ä¸Šæ–¹é€‰æ‹©ä¸€æœ¬å°è¯´å¼€å§‹é…ç½®</p>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<script>
    // å®šä¹‰åŸºç¡€ API åœ°å€
    const API_BASE = "http://localhost:8888";
    const URLS = {
        NOVEL_LIST: `${API_BASE}/api/novels`,
        CHARACTERS: `${API_BASE}/gemini/characters`,
        MODELS: `${API_BASE}/gemini/characters/version`
    };

    $(document).ready(function() {
        // 1. åˆå§‹åŒ– Select2
        $('#novelSelect').select2({
            theme: 'bootstrap-5',
            width: '280px',
            placeholder: 'â³ æ•°æ®åŠ è½½ä¸­...',
        });

        // 2. é¡µé¢åŠ è½½å®Œæ¯•åï¼Œç«‹å³è·å–å°è¯´åˆ—è¡¨
        loadNovelList();

        // 3. ç»‘å®šå˜æ›´äº‹ä»¶
        $('#novelSelect').change(function() {
            const novelName = $(this).val();
            if(novelName) loadTableData(novelName);
        });
    });

    // æ ¸å¿ƒä¿®æ”¹ï¼šè·å–å°è¯´åˆ—è¡¨å‡½æ•° (å¸¦è¯¦ç»†è°ƒè¯•æ—¥å¿—)
    async function loadNovelList() {
        const $select = $('#novelSelect');

        try {
            console.log("ğŸš€ å¼€å§‹è¯·æ±‚å°è¯´åˆ—è¡¨...");
            // å‘èµ·è¯·æ±‚
            const res = await $.get(URLS.NOVEL_LIST);

            console.log("âœ… åç«¯è¿”å›åŸå§‹æ•°æ®:", res);

            // æ¸…ç©ºæ—§æ•°æ®ï¼ˆä¿ç•™ä¸€ä¸ªä¸´æ—¶æç¤ºï¼‰
            $select.empty();

            // ä¸¥æ ¼æ ¡éªŒè¿”å›ç»“æ„
            if (res && res.code === 1 && Array.isArray(res.data)) {

                console.log(`ğŸ“Š è·å–åˆ° ${res.data.length} æœ¬å°è¯´`);

                // 1. æ·»åŠ é»˜è®¤æç¤ºé€‰é¡¹
                $select.append('<option value="" disabled selected>ğŸ” è¯·é€‰æ‹©ä¸€æœ¬å°è¯´</option>');

                // 2. éå†æ·»åŠ æ•°æ®
                res.data.forEach(novelName => {
                    // ç¡®ä¿ novelName æ˜¯å­—ç¬¦ä¸²
                    const nameStr = String(novelName);
                    // æ„é€  Option å¯¹è±¡ (ä½¿ç”¨ Option æ„é€ å‡½æ•°æ¯”å­—ç¬¦ä¸²æ‹¼æ¥æ›´å®‰å…¨)
                    const newOption = new Option(`ğŸ“š ${nameStr}`, nameStr, false, false);
                    $select.append(newOption);
                });

                console.log("ğŸ‰ åˆ—è¡¨æ¸²æŸ“å®Œæˆ");

            } else {
                console.warn("âš ï¸ æ•°æ®æ ¼å¼ä¸ç¬¦åˆé¢„æœŸæˆ–ä¸ºç©º:", res);
                $select.append('<option value="" disabled>âš ï¸ æš‚æ— å°è¯´æ•°æ®</option>');
            }

        } catch (error) {
            console.error("âŒ è¯·æ±‚å¤±è´¥ (è¯·æ£€æŸ¥ç½‘ç»œæˆ–è·¨åŸŸCORS):", error);
            $select.empty();
            $select.append('<option value="" disabled selected>âŒ è¿æ¥æœåŠ¡å™¨å¤±è´¥</option>');
        }

        // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œæœ€åéƒ½è¦é€šçŸ¥ Select2 æ›´æ–° UI
        $select.trigger('change.select2');
    }

    // åŠ è½½è¡¨æ ¼æ•°æ® (é€»è¾‘ä¿æŒä¸å˜ï¼Œä»…ä¿®æ”¹äº† URL å¼•ç”¨)
    async function loadTableData(novelName) {
        const $tbody = $('#tableBody');
        $tbody.html(`
            <tr>
                <td colspan="5" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="mt-3 text-muted">æ­£åœ¨åŠ è½½æ•°æ®...</p>
                </td>
            </tr>
        `);

        try {
            console.log("å‘èµ·è¯·æ±‚:", novelName);

            const [charRes, modelRes] = await Promise.all([
                $.get(`${URLS.CHARACTERS}/${encodeURIComponent(novelName)}`),
                $.get(`${URLS.MODELS}/${encodeURIComponent(novelName)}`)
            ]);

            const characters = (charRes.code === 1) ? charRes.data : [];
            const modelList = (modelRes.code === 1) ? modelRes.data : [];

            if (!characters || characters.length === 0) {
                $tbody.html(`
                    <tr>
                        <td colspan="5">
                            <div class="empty-state">
                                <i class="bi bi-exclamation-triangle text-danger"></i>
                                <p class="text-danger">è¯¥å°è¯´æš‚æ— è§’è‰²æ•°æ®</p>
                            </div>
                        </td>
                    </tr>
                `);
                return;
            }

            renderTable(characters, modelList);

        } catch (error) {
            console.error(error);
            $tbody.html(`
                <tr>
                    <td colspan="5">
                        <div class="empty-state">
                            <i class="bi bi-wifi-off text-danger"></i>
                            <p class="text-danger">è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>
                        </div>
                    </td>
                </tr>
            `);
        }
    }

    function renderTable(characters, modelList) {
        const $tbody = $('#tableBody');
        $tbody.empty();

        let baseOptions = modelList.map(m =>
            `<option value="${m.modelname}">${m.modelname}</option>`
        ).join('');

        characters.forEach((char, index) => {
            let genderClass = 'gender-unknown';
            let icon = 'bi-question-circle';
            if (char.gender === 'ç”·') {
                genderClass = 'gender-male';
                icon = 'bi-gender-male';
            }
            else if (char.gender === 'å¥³') {
                genderClass = 'gender-female';
                icon = 'bi-gender-female';
            }

            const currentModel = char.characterName;
            let rowOptions = '<option value="">-- æœªç»‘å®šæ¨¡å‹ --</option>';

            if (currentModel) {
                rowOptions += `<option value="${currentModel}" selected>âœ“ ${currentModel}</option>`;
            }

            rowOptions += baseOptions;

            const rowHtml = `
                <tr style="animation: slideIn 0.3s ease-out ${index * 0.05}s both;">
                    <td><span class="id-badge">${char.id}</span></td>
                    <td><span class="char-name">${char.name}</span></td>
                    <td><span class="gender-badge ${genderClass}"><i class="bi ${icon}"></i> ${char.gender}</span></td>
                    <td><span class="version-badge">${char.version}</span></td>
                    <td>
                        <select class="form-select model-select" data-char-id="${char.id}">
                            ${rowOptions}
                        </select>
                    </td>
                </tr>
            `;
            $tbody.append(rowHtml);
        });

        // é‡æ–°åˆå§‹åŒ–è¡¨æ ¼å†…çš„ Select2
        $('.model-select').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: 'ğŸ” æœç´¢å¹¶é€‰æ‹©æ¨¡å‹...',
            allowClear: true
        });

        $('.model-select').on('change', function() {
            const charId = $(this).data('char-id');
            const newModel = $(this).val();
            // è¿™é‡Œå¯ä»¥æ·»åŠ ä¿å­˜åˆ°åç«¯çš„é€»è¾‘
            console.log(`âœ“ è§’è‰²ID: ${charId} -> æ–°æ¨¡å‹: ${newModel || 'æœªç»‘å®š'}`);

            $(this).closest('tr').css('background', '#d4edda');
            setTimeout(() => {
                $(this).closest('tr').css('background', '');
            }, 1000);
        });
    }
</script>
</body>
</html>